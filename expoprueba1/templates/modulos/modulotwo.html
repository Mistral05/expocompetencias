<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Módulo 2: Funciones</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    
    <script>
    tailwind.config = {
        theme: {
        extend: {
            colors: {
            "primary": "#753232",
            "secondary": "#9E5E5E", 
            "accent-gold": "#C9B037",
            "light-gray": "#f7f9fa",
            "text-primary": "#1f2937",
            "success": "#10b981",
            "error": "#ef4444"
            },
            fontFamily: {
            "display": ["Lexend", "sans-serif"]
            }
        },
        },
    }
    </script>
    
    <style>
        /* --- TUS ESTILOS PERSONALIZADOS (HEADER COMPACTO) --- */
        :root {
            --color-text-primary: #1f2937;
        }

        .header {
            margin-left: 2rem;
            margin-right: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem; 
            padding-bottom: 0.75rem;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h2 {
            font-size: 1.25rem; 
            font-weight: 700;
            color: var(--color-text-primary);
            letter-spacing: -0.05em;
            padding-left: 1rem; 
            border-left: 2px solid #e5e7eb;
            margin-left: 0.5rem;
        }

        .logo-icon img {
            width: 5.5rem; 
            height: 1.75rem; 
            object-fit: contain;
        }

        .nav-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* --- Estilos de funcionalidad --- */
        .hidden-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .transition-width { transition-property: width; transition-duration: 700ms; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        
        .graph-grid {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px), linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="font-display bg-light-gray text-text-primary h-screen flex flex-col overflow-hidden">

    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <img src="{{ url_for('static', filename='img/DGET.png') }}" alt="Logo DGET" />
            </div>
            <div style="width: 1px; height: 1.25rem; background-color: #d1d5db;"></div>
            <div class="logo-icon">
                <img src="{{ url_for('static', filename='img/glo.png') }}" alt="Logo GLO" />
            </div>
            <h2>Módulo 2: Funciones</h2>
        </div>

        <div class="nav-actions">
            <div class="hidden lg:flex items-center gap-2 w-32 mr-4">
                <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                    <div id="module-progress-bar" class="h-full bg-success transition-width" style="width: {{ progreso }};"></div>
                </div>
                <span class="text-xs font-black text-success" id="module-progress-percentage">{{ progreso }}</span>
            </div>

            <a href="/" class="px-4 py-1.5 rounded-lg bg-gray-50 text-gray-600 font-bold text-xs hover:bg-primary hover:text-white transition-all border border-gray-200">
                Inicio
            </a>
            <a href="{{ url_for('dashboard') }}" class="flex items-center justify-center w-8 h-8 rounded-lg bg-red-50 text-primary hover:bg-red-100 transition-colors" title="Salir">
                <span class="material-symbols-outlined text-[18px]">logout</span>
            </a>
        </div>
    </header>
    
    <div class="flex flex-1 overflow-hidden w-full">

        <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col hidden md:flex h-full shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="flex items-center gap-2 mb-6 text-primary border-b border-gray-100 pb-4">
                    <span class="material-symbols-outlined text-xl">menu_book</span>
                    <h3 class="font-bold uppercase tracking-widest text-xs">Temario</h3>
                </div>
                
                <div class="relative pl-3 border-l-2 border-gray-100 space-y-1">
                    <div class="relative py-2">
                        <div class="absolute -left-[17px] top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full bg-white border-2 border-primary z-10" id="dot-2.1"></div>
                        <button id="btn-2.1" onclick="switchLesson('2.1')" class="nav-btn w-full text-left pl-4 text-sm font-medium transition-colors text-primary font-bold hover:translate-x-1 transition-transform">
                            2.1 Definición
                        </button>
                    </div>

                    <div class="relative py-2">
                        <div class="absolute -left-[17px] top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full bg-white border-2 border-gray-300 z-10" id="dot-2.2"></div>
                        <button id="btn-2.2" onclick="switchLesson('2.2')" class="nav-btn w-full text-left pl-4 text-sm font-medium transition-colors text-gray-400 cursor-not-allowed flex justify-between items-center group">
                            <span>2.2 Gráficas Lineales</span>
                            <span id="lock-2.2" class="material-symbols-outlined text-xs text-gray-300">lock</span>
                        </button>
                    </div>

                    <div class="relative py-2">
                        <div class="absolute -left-[17px] top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full bg-white border-2 border-gray-300 z-10" id="dot-2.3"></div>
                        <button id="btn-2.3" onclick="switchLesson('2.3')" class="nav-btn w-full text-left pl-4 text-sm font-medium transition-colors text-gray-400 cursor-not-allowed flex justify-between items-center group">
                            <span>2.3 Dom. y Rango</span>
                            <span id="lock-2.3" class="material-symbols-outlined text-xs text-gray-300">lock</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <div class="flex gap-3 items-start">
                    <span class="material-symbols-outlined text-accent-gold text-lg mt-0.5">lightbulb</span>
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase mb-0.5">Tip Rápido</p>
                        <p class="text-xs text-gray-600 leading-snug">Cada respuesta correcta desbloquea el siguiente tema.</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="flex-1 overflow-y-auto p-8 scroll-smooth bg-light-gray relative">
            
            <div id="lesson-2.1" class="lesson-container active-section max-w-4xl mx-auto space-y-10">
                
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="bg-accent-gold/10 text-accent-gold px-3 py-1 rounded text-xs font-bold uppercase tracking-wider">Lección 2.1</span>
                    </div>
                    <h2 class="text-4xl font-black text-primary mb-6">¿Qué es una Función?</h2>
                    
                    <p class="text-gray-600 leading-relaxed text-lg mb-6">
                        En matemáticas, una función es como una <strong>regla especial</strong> o una máquina. Esta regla toma un valor de entrada (que usualmente llamamos <em>x</em>) y le asigna <strong>exclusivamente</strong> un valor de salida (que llamamos <em>y</em> o <em>f(x)</em>).
                    </p>
                    <p class="text-gray-600 leading-relaxed text-lg mb-8">
                        La regla de oro es: <strong>Para cada entrada, solo puede haber una salida.</strong> Si metes una moneda en una máquina expendedora y presionas "B2", siempre debe caer el mismo chocolate. Si a veces cae un refresco y a veces papitas, ¡la máquina no funciona! No es una función.
                    </p>

                    <div class="flex flex-col md:flex-row gap-8 items-center bg-blue-50/50 p-8 rounded-xl border border-blue-100">
                        <div class="flex-1">
                            <h4 class="font-bold text-blue-900 mb-3 text-lg flex items-center gap-2">
                                <span class="material-symbols-outlined">smart_toy</span> La Máquina "f(x)"
                            </h4>
                            <p class="text-base text-blue-800/80 leading-relaxed">
                                Imagina una caja donde entra un número, ocurre una operación matemática adentro, y sale un resultado. 
                                <br><br>
                                Si la regla es <span class="font-mono bg-white px-1 rounded font-bold">f(x) = x + 2</span>:
                                <ul class="list-disc list-inside mt-2 ml-2">
                                    <li>Entra 3 → Sale 5</li>
                                    <li>Entra 10 → Sale 12</li>
                                </ul>
                            </p>
                        </div>
                        <div class="w-full md:w-1/3 flex justify-center">
                            <div class="relative flex flex-col items-center">
                                <div class="w-12 h-8 bg-gray-300 mb-[-5px] z-0 flex items-center justify-center text-xs font-bold animate-bounce">x</div>
                                <div class="w-32 h-24 bg-primary rounded-xl z-10 flex items-center justify-center text-white font-mono text-xl shadow-lg border-b-4 border-red-900 relative">
                                    f(x)
                                    <div class="absolute -right-4 top-8 w-6 h-2 bg-gray-800 rounded-r"></div> </div>
                                <div class="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[15px] border-t-primary mt-[-1px] z-10"></div>
                                <div class="w-12 h-8 bg-green-100 border border-green-300 mt-2 flex items-center justify-center text-xs font-bold text-green-800">y</div>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="form-2.1" onsubmit="event.preventDefault(); validateDef();">
                    <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-2xl p-8 shadow-sm">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="p-2 bg-accent-gold/20 rounded-lg text-accent-gold">
                                <span class="material-symbols-outlined">quiz</span>
                            </div>
                            <h3 class="font-bold text-gray-900 text-xl">Prueba de Concepto</h3>
                        </div>
                        
                        <p class="mb-8 text-gray-600 text-lg">
                            Analiza estas situaciones. ¿Cuál representa una <strong>función verdadera</strong>? recuerde: 1 entrada = 1 salida única.
                        </p>
                        
                        <div class="grid grid-cols-1 gap-4 mb-8">
                            <label class="cursor-pointer group p-4 border-2 border-gray-100 rounded-xl hover:bg-white hover:border-primary/30 transition-all flex items-start gap-4 bg-white">
                                <input type="radio" name="q2_def" value="A" class="mt-1 text-primary focus:ring-primary h-5 w-5 bg-gray-100 border-gray-300">
                                <div>
                                    <span class="block font-bold text-gray-800 mb-1">Un alumno tiene 3 números de teléfono diferentes.</span>
                                    <span class="text-sm text-gray-500">Entrada: Alumno -> Salidas: Teléfono A, Teléfono B, Teléfono C.</span>
                                </div>
                            </label>
                            
                            <label class="cursor-pointer group p-4 border-2 border-gray-100 rounded-xl hover:bg-white hover:border-primary/30 transition-all flex items-start gap-4 bg-white">
                                <input type="radio" name="q2_def" value="B" class="mt-1 text-primary focus:ring-primary h-5 w-5 bg-gray-100 border-gray-300">
                                <div>
                                    <span class="block font-bold text-gray-800 mb-1">Cada persona tiene una única fecha de nacimiento.</span>
                                    <span class="text-sm text-gray-500">Entrada: Persona -> Salida: Una sola fecha.</span>
                                </div>
                            </label>
                        </div>

                        <div id="feedback-2.1" class="hidden mb-6 p-4 rounded-xl items-start gap-3 text-sm font-medium border"></div>

                        <button type="submit" class="w-full sm:w-auto px-8 py-3 bg-primary text-white font-bold rounded-xl hover:bg-secondary transition-all shadow-lg shadow-primary/20 hover:-translate-y-0.5">
                            Comprobar Respuesta
                        </button>
                    </div>
                </form>
            </div>

            <div id="lesson-2.2" class="lesson-container hidden-section max-w-4xl mx-auto space-y-10">
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100">
                    <span class="bg-accent-gold/10 text-accent-gold px-3 py-1 rounded text-xs font-bold uppercase tracking-wider">Lección 2.2</span>
                    <h2 class="text-4xl font-black text-primary mt-4 mb-6">Gráficas Lineales</h2>
                    <p class="text-gray-600 text-lg leading-relaxed mb-8">
                        Una función lineal tiene la forma general <span class="font-mono bg-yellow-50 px-2 rounded font-bold text-primary">f(x) = mx + b</span>. Su gráfica siempre será una línea recta.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-6">
                            <h4 class="font-bold text-gray-900 text-xl border-b pb-2">Los Componentes</h4>
                            
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-700 flex items-center justify-center font-bold text-xl font-mono shrink-0">m</div>
                                <div>
                                    <p class="font-bold text-gray-800">Pendiente</p>
                                    <p class="text-sm text-gray-600">Indica la inclinación de la recta. Si es positiva, sube; si es negativa, baja.</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-lg bg-purple-100 text-purple-700 flex items-center justify-center font-bold text-xl font-mono shrink-0">b</div>
                                <div>
                                    <p class="font-bold text-gray-800">Intersección Y</p>
                                    <p class="text-sm text-gray-600">Es el punto donde la línea cruza el eje vertical (cuando x = 0).</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center justify-center bg-gray-50 rounded-2xl p-6 border border-gray-200">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Ejemplo: f(x) = x + 1</span>
                            <div class="relative w-full aspect-square graph-grid border border-gray-300 rounded-lg overflow-hidden bg-white shadow-inner max-w-[250px]">
                                <div class="absolute top-1/2 left-0 w-full h-px bg-gray-800"></div>
                                <div class="absolute left-1/2 top-0 h-full w-px bg-gray-800"></div>
                                <div class="absolute w-[150%] h-1 bg-secondary top-[40%] left-1/2 -translate-x-1/2 -translate-y-1/2 origin-center rotate-[-45deg]"></div>
                                <div class="absolute top-[40%] left-[50%] w-3 h-3 bg-primary rounded-full border-2 border-white -translate-x-1/2 -translate-y-1/2 z-10" title="Intersección b=1"></div>
                            </div>
                            <p class="text-[10px] text-center text-gray-400 mt-3">
                                Aquí m=1 (sube en 45°) y b=1 (cruza arriba del origen).
                            </p>
                        </div>
                    </div>
                </div>

                <form id="form-2.2" onsubmit="event.preventDefault(); validateGraph();">
                    <div class="bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-2xl p-8 shadow-sm">
                        <div class="bg-white p-8 rounded-2xl border-2 border-dashed border-gray-300 mb-8 flex flex-col items-center justify-center text-center">
                            <label class="block text-sm font-bold text-gray-500 mb-4 uppercase tracking-widest">Cálculo Rápido</label>
                            <p class="mb-6 text-gray-700 font-medium text-lg">
                                Dada la función <span class="text-primary font-mono font-bold">f(x) = 2x + 3</span>.
                                <br>
                                Si la entrada es <strong>x = 4</strong>, ¿cuál es la salida?
                            </p>
                            
                            <div class="flex items-center gap-3">
                                <span class="text-3xl font-mono font-bold text-gray-300">f(4) =</span>
                                <input type="number" id="q_graph_result" class="form-input text-4xl font-bold text-primary w-32 rounded-xl border-2 border-gray-200 focus:border-primary focus:ring-4 focus:ring-primary/10 text-center bg-white py-2 shadow-sm transition-all placeholder-gray-100" placeholder="?">
                            </div>
                        </div>

                        <div id="feedback-2.2" class="hidden mb-6 p-4 rounded-xl items-start gap-3 text-sm font-medium border"></div>

                        <button type="submit" class="w-full sm:w-auto px-8 py-3 bg-primary text-white font-bold rounded-xl hover:bg-secondary transition-all shadow-lg shadow-primary/20 hover:-translate-y-0.5">
                            Verificar Cálculo
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="lesson-2.3" class="lesson-container hidden-section max-w-4xl mx-auto space-y-10">
                
                <div class="bg-white p-10 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row gap-8 items-start">
                        <div class="flex-1">
                            <span class="bg-accent-gold/10 text-accent-gold px-3 py-1 rounded text-xs font-bold uppercase tracking-wider">Lección 2.3</span>
                            <h2 class="text-4xl font-black text-primary mt-4 mb-4">Dominio y Rango</h2>
                            <p class="text-gray-600 text-lg mb-6 leading-relaxed">
                                Toda función trabaja con dos conjuntos principales de números. Es vital entender qué valores pueden entrar y qué valores pueden salir.
                            </p>
                            
                            <div class="space-y-4">
                                <div class="bg-green-50 p-4 rounded-xl border border-green-100 flex gap-4">
                                    <div class="bg-white p-2 rounded-lg h-fit border border-green-200 font-mono font-bold text-green-700">D</div>
                                    <div>
                                        <h5 class="font-bold text-green-900 text-sm">Dominio (Entradas)</h5>
                                        <p class="text-sm text-green-800/80">
                                            Son todos los valores posibles de <strong>x</strong> que la función acepta sin romperse (como dividir por cero).
                                        </p>
                                    </div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 flex gap-4">
                                    <div class="bg-white p-2 rounded-lg h-fit border border-orange-200 font-mono font-bold text-orange-700">R</div>
                                    <div>
                                        <h5 class="font-bold text-orange-900 text-sm">Rango (Salidas)</h5>
                                        <p class="text-sm text-orange-800/80">
                                            Son todos los valores posibles de <strong>y</strong> que resultan de aplicar la función.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="w-full md:w-64 bg-gray-50 rounded-xl p-6 border border-gray-200 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-gray-800 mb-4 text-xs uppercase">Mapeo</h4>
                            <div class="flex items-center gap-4">
                                <div class="border-2 border-green-400 bg-white w-16 h-32 rounded-[2rem] flex flex-col items-center justify-center gap-2 shadow-sm">
                                    <span class="text-xs font-bold text-gray-400 mb-1">Dom</span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <span class="material-symbols-outlined text-gray-300 text-sm">arrow_forward</span>
                                    <span class="material-symbols-outlined text-gray-300 text-sm">arrow_forward</span>
                                    <span class="material-symbols-outlined text-gray-300 text-sm">arrow_forward</span>
                                </div>
                                <div class="border-2 border-orange-400 bg-white w-16 h-32 rounded-[2rem] flex flex-col items-center justify-center gap-2 shadow-sm">
                                    <span class="text-xs font-bold text-gray-400 mb-1">Ran</span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="form-2.3" action="{{ url_for('lesson_submit') }}" method="POST" onsubmit="event.preventDefault(); validateDomain();">
                    <input type="hidden" name="unit_id" value="2">
                    
                    <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-sm mb-10 relative overflow-hidden">
                        
                        <div class="flex items-center gap-3 mb-6 relative z-10">
                            <div class="p-2 bg-primary/10 rounded-lg text-primary">
                                <span class="material-symbols-outlined">school</span>
                            </div>
                            <h3 class="font-bold text-gray-900 text-xl">Examen Final del Módulo</h3>
                        </div>

                        <p class="text-gray-600 mb-8 text-base relative z-10">
                            Observa la notación de función estándar: <span class="font-mono bg-gray-100 px-2 rounded font-bold">f(x) = y</span>.
                            <br>¿Cuál de las siguientes afirmaciones es correcta sobre el <strong>Dominio</strong>?
                        </p>
                        
                        <div class="space-y-4 relative z-10 mb-8">
                            <label class="flex items-center p-4 rounded-xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-primary/30 transition-all cursor-pointer group shadow-sm">
                                <input type="radio" name="final_q" value="A" class="text-primary focus:ring-primary h-5 w-5 bg-gray-100 border-gray-300">
                                <span class="ml-4 text-gray-600 group-hover:text-primary transition-colors">Son todos los valores de salida (y).</span>
                            </label>
                            <label class="flex items-center p-4 rounded-xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-primary/30 transition-all cursor-pointer group shadow-sm">
                                <input type="radio" name="final_q" value="B" class="text-primary focus:ring-primary h-5 w-5 bg-gray-100 border-gray-300">
                                <span class="ml-4 text-gray-600 group-hover:text-primary transition-colors">Son todos los valores de entrada permitidos (x).</span>
                            </label>
                            <label class="flex items-center p-4 rounded-xl bg-white hover:bg-gray-50 border border-gray-200 hover:border-primary/30 transition-all cursor-pointer group shadow-sm">
                                <input type="radio" name="final_q" value="C" class="text-primary focus:ring-primary h-5 w-5 bg-gray-100 border-gray-300">
                                <span class="ml-4 text-gray-600 group-hover:text-primary transition-colors">Es el nombre de la función (f).</span>
                            </label>
                        </div>

                        <div id="feedback-2.3" class="hidden mt-4 p-4 rounded-xl flex items-center gap-4 text-sm font-medium border relative z-10 shadow-sm">
                            <span class="material-symbols-outlined icon text-2xl p-2 bg-white rounded-full shadow-sm"></span>
                            <span class="message flex-1 text-base"></span>
                        </div>

                        <button type="submit" class="mt-4 w-full py-4 bg-primary text-white text-lg font-bold rounded-xl hover:bg-secondary transition-all shadow-xl shadow-primary/20 flex items-center justify-center gap-3 hover:-translate-y-1 relative z-10">
                            <span class="material-symbols-outlined">check_circle</span>
                            Terminar Módulo 2
                        </button>
                    </div>
                </form>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const completedLessons = new Set(); 
        const unlockedLessons = new Set(['2.1']); // Solo 2.1 abierto al inicio
        const totalLessons = 3; 

        function updateModuleProgress(lessonId) {
            if (completedLessons.has(lessonId)) return;
            completedLessons.add(lessonId); 
            const currentCompleted = completedLessons.size;
            let percentage = Math.round((currentCompleted / totalLessons) * 100);
            
            const progressDisplay = document.getElementById('module-progress-percentage');
            const progressBar = document.getElementById('module-progress-bar');
            
            if (progressDisplay) progressDisplay.textContent = `${percentage}%`;
            if (progressBar) progressBar.style.width = `${percentage}%`; 
        }

        // --- FUNCIONES DE DESBLOQUEO ---
        function unlockNextLesson(nextLessonId) {
            if (!unlockedLessons.has(nextLessonId)) {
                unlockedLessons.add(nextLessonId);
                
                const btn = document.getElementById('btn-' + nextLessonId);
                const lock = document.getElementById('lock-' + nextLessonId);
                
                if (btn) {
                    btn.classList.remove('text-gray-400', 'cursor-not-allowed');
                    btn.classList.add('text-gray-500', 'hover:text-primary', 'hover:translate-x-1');
                    // Animación visual
                    btn.animate([
                        { transform: 'scale(1)', color: '#10b981' },
                        { transform: 'scale(1.05)' },
                        { transform: 'scale(1)', color: '#6b7280' }
                    ], { duration: 500 });
                }
                if (lock) {
                    lock.textContent = 'lock_open';
                    setTimeout(() => lock.style.display = 'none', 1000);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si ya completó el módulo previamente
            const progressPercentageText = document.getElementById('module-progress-percentage');
            if (progressPercentageText && progressPercentageText.textContent.startsWith('100')) {
                ['2.1', '2.2', '2.3'].forEach(id => {
                    completedLessons.add(id);
                    unlockNextLesson(id);
                });
            }
            switchLesson('2.1');
        });

        // --- NAVEGACIÓN SEGURA ---
        function switchLesson(lessonId) {
            if (!unlockedLessons.has(lessonId)) {
                // Efecto de negación si está bloqueado
                const btn = document.getElementById('btn-' + lessonId);
                if(btn) {
                    btn.animate([
                        { transform: 'translateX(0)' },
                        { transform: 'translateX(-4px)' },
                        { transform: 'translateX(4px)' },
                        { transform: 'translateX(0)' }
                    ], { duration: 300 });
                }
                return; 
            }

            document.querySelectorAll('.lesson-container').forEach(el => {
                el.classList.add('hidden-section');
                el.classList.remove('active-section');
            });
            const target = document.getElementById('lesson-' + lessonId);
            if(target) {
                target.classList.remove('hidden-section');
                target.classList.add('active-section');
            }

            // Actualizar Sidebar
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (unlockedLessons.has(btn.id.replace('btn-', ''))) {
                    btn.classList.remove('text-primary', 'font-bold');
                    btn.classList.add('text-gray-500');
                }
                const dot = btn.previousElementSibling;
                if(dot) {
                    dot.classList.remove('border-primary');
                    dot.classList.add('border-gray-300');
                }
            });

            const activeBtn = document.getElementById('btn-' + lessonId);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-500');
                activeBtn.classList.add('text-primary', 'font-bold');
                const dot = activeBtn.previousElementSibling;
                if(dot) {
                    dot.classList.remove('border-gray-300');
                    dot.classList.add('border-primary');
                }
            }
        }

        // --- VALIDACIONES MÓDULO 2 ---

        function validateDef() {
            const answer = document.querySelector('input[name="q2_def"]:checked');
            const feedback = document.getElementById('feedback-2.1');
            
            feedback.className = "hidden mb-6 p-4 rounded-xl flex items-start gap-3 text-sm font-medium border"; 

            if (answer && answer.value === 'B') {
                feedback.classList.remove('hidden');
                feedback.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
                feedback.innerHTML = '<span class="material-symbols-outlined text-green-600 text-2xl">check_circle</span> <div><strong>¡Correcto!</strong> Una fecha única por persona cumple la regla de función.</div>';
                
                updateModuleProgress('2.1'); 
                unlockNextLesson('2.2');
                setTimeout(() => switchLesson('2.2'), 2000); 
            } else {
                feedback.classList.remove('hidden');
                feedback.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                feedback.innerHTML = '<span class="material-symbols-outlined text-red-600 text-2xl">cancel</span> <div><strong>Incorrecto.</strong> Un alumno con 3 teléfonos es "uno a muchos". Eso NO es función.</div>';
            }
        }

        function validateGraph() {
            const inputVal = document.getElementById('q_graph_result').value;
            const feedback = document.getElementById('feedback-2.2');
            
            feedback.className = "hidden mb-6 p-4 rounded-xl flex items-start gap-3 text-sm font-medium border"; 

            if (parseInt(inputVal) === 11) { // 2(4) + 3 = 8 + 3 = 11
                feedback.classList.remove('hidden');
                feedback.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
                feedback.innerHTML = '<span class="material-symbols-outlined text-green-600 text-2xl">check_circle</span> <div><strong>¡Exacto!</strong> 2(4) + 3 = 11.</div>';
                
                updateModuleProgress('2.2'); 
                unlockNextLesson('2.3');
                setTimeout(() => switchLesson('2.3'), 2000); 
            } else {
                feedback.classList.remove('hidden');
                feedback.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                feedback.innerHTML = '<span class="material-symbols-outlined text-red-600 text-2xl">cancel</span> <div><strong>Revisa el cálculo.</strong> Multiplica 2 por 4, y luego suma 3.</div>';
            }
        }

        function validateDomain() {
            const form = document.getElementById('form-2.3');
            const answer = document.querySelector('input[name="final_q"]:checked');
            const feedback = document.getElementById('feedback-2.3');
            const icon = feedback.querySelector('.icon');
            const msg = feedback.querySelector('.message');

            feedback.className = "mt-4 p-4 rounded-xl flex items-center gap-4 text-sm font-medium border relative z-10 shadow-sm";
            feedback.classList.remove('hidden');

            if (answer && answer.value === 'B') {
                updateModuleProgress('2.3'); 
                
                const hiddenSuccess = document.createElement("input");
                hiddenSuccess.type = "hidden";
                hiddenSuccess.name = "module_completed";
                hiddenSuccess.value = "true";
                form.appendChild(hiddenSuccess);

                feedback.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                icon.innerText = "workspace_premium";
                msg.innerHTML = "<strong>¡Felicidades!</strong> Módulo de Funciones completado. Guardando...";

                setTimeout(() => form.submit(), 1500);
            } else {
                feedback.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                icon.innerText = "error";
                msg.innerText = "Incorrecto. Recuerda: Dominio = Entradas (x), Rango = Salidas (y).";
            }
        }
    </script>
</body>
</html>